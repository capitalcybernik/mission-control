<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚öîÔ∏è Mission Control ‚Äî Capital Cyber</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#050508;--card:rgba(255,255,255,0.03);--border:rgba(255,255,255,0.06);
  --blue:#3b82f6;--green:#10b981;--orange:#f97316;--yellow:#f59e0b;--red:#ef4444;
  --purple:#8b5cf6;--gray:#6b7280;--text:#e2e8f0;--muted:#94a3b8;
  --radius:16px;--transition:0.3s ease;
}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
a{color:var(--blue);text-decoration:none}a:hover{text-decoration:underline}

/* Scrollbar */
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:3px}

/* Header */
.header{position:sticky;top:0;z-index:100;backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  background:rgba(5,5,8,0.8);border-bottom:1px solid var(--border);padding:0 2rem;display:flex;align-items:center;justify-content:space-between;height:64px}
.header-brand{font-size:1.25rem;font-weight:700;white-space:nowrap}
.header-tabs{display:flex;gap:0.25rem;overflow-x:auto;scrollbar-width:none}
.header-tabs::-webkit-scrollbar{display:none}
.tab-btn{background:none;border:none;color:var(--muted);font-family:inherit;font-size:0.8rem;font-weight:500;
  padding:0.5rem 0.75rem;border-radius:8px;cursor:pointer;white-space:nowrap;transition:var(--transition)}
.tab-btn:hover{color:var(--text);background:rgba(255,255,255,0.05)}
.tab-btn.active{color:#fff;background:rgba(59,130,246,0.15);box-shadow:0 0 12px rgba(59,130,246,0.1)}
.status-dot{width:10px;height:10px;background:var(--green);border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(16,185,129,0.4)}50%{opacity:0.8;box-shadow:0 0 0 8px rgba(16,185,129,0)}}

/* Main */
.main{max-width:1600px;margin:0 auto;padding:2.5rem}
.tab-content{display:none;animation:fadeInUp 0.4s ease}
.tab-content.active{display:block}
@keyframes fadeInUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

/* Cards */
.card{background:var(--card);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;transition:var(--transition)}
.card:hover{box-shadow:0 0 20px rgba(59,130,246,0.15);border-color:rgba(59,130,246,0.15)}
.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1.5rem}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.5rem;margin-bottom:2rem}
.stat-card{text-align:center}
.stat-value{font-size:2rem;font-weight:800;color:#fff}
.stat-label{font-size:0.85rem;color:var(--muted);margin-top:0.25rem}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:0.5rem;padding:0.6rem 1.2rem;border:none;border-radius:10px;
  font-family:inherit;font-size:0.85rem;font-weight:600;cursor:pointer;transition:var(--transition)}
.btn-primary{background:var(--blue);color:#fff}.btn-primary:hover{box-shadow:0 0 20px rgba(59,130,246,0.4)}
.btn-sm{padding:0.35rem 0.75rem;font-size:0.75rem;border-radius:8px}
.btn-danger{background:rgba(239,68,68,0.15);color:var(--red)}.btn-danger:hover{background:rgba(239,68,68,0.25)}
.btn-ghost{background:rgba(255,255,255,0.05);color:var(--text)}.btn-ghost:hover{background:rgba(255,255,255,0.1)}
.btn-row{display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:1rem}

/* Forms */
.form-group{margin-bottom:1rem}
.form-group label{display:block;font-size:0.8rem;font-weight:500;color:var(--muted);margin-bottom:0.35rem}
.form-input,.form-select,.form-textarea{width:100%;padding:0.6rem 0.8rem;background:rgba(255,255,255,0.05);
  border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:inherit;font-size:0.85rem;transition:var(--transition)}
.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(59,130,246,0.15)}
.form-textarea{min-height:80px;resize:vertical}
.form-select option{background:#1a1a2e;color:var(--text)}
.inline-form{background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;margin-bottom:1.5rem;animation:fadeInUp 0.3s ease}

/* Badges */
.badge{display:inline-block;padding:0.2rem 0.6rem;border-radius:20px;font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.03em}
.badge-active{background:rgba(16,185,129,0.15);color:var(--green)}
.badge-paused,.badge-pending,.badge-busy{background:rgba(245,158,11,0.15);color:var(--yellow)}
.badge-completed,.badge-call{background:rgba(59,130,246,0.15);color:var(--blue)}
.badge-churned{background:rgba(239,68,68,0.15);color:var(--red)}
.badge-high{background:rgba(239,68,68,0.15);color:var(--red)}
.badge-medium{background:rgba(245,158,11,0.15);color:var(--yellow)}
.badge-low{background:rgba(107,114,128,0.15);color:var(--gray)}
.badge-offline{background:rgba(107,114,128,0.15);color:var(--gray)}
.badge-online{background:rgba(16,185,129,0.15);color:var(--green)}
.badge-zoom{background:rgba(139,92,246,0.15);color:var(--purple)}
.badge-in-person{background:rgba(16,185,129,0.15);color:var(--green)}
.badge-cmmc{background:rgba(59,130,246,0.15);color:var(--blue)}
.badge-trends{background:rgba(139,92,246,0.15);color:var(--purple)}
.badge-competitor{background:rgba(239,68,68,0.15);color:var(--red)}
.badge-opportunities{background:rgba(16,185,129,0.15);color:var(--green)}
.badge-hot{background:rgba(239,68,68,0.2);color:var(--red)}
.badge-notable{background:rgba(245,158,11,0.2);color:var(--yellow)}
.badge-reference{background:rgba(107,114,128,0.2);color:var(--gray)}

/* Section titles */
.section-title{font-size:1.3rem;font-weight:700;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem}
.section-sub{font-size:0.85rem;color:var(--muted);margin-bottom:1.5rem}

/* Welcome */
.welcome{font-size:1.8rem;font-weight:800;margin-bottom:0.5rem}
.welcome-sub{color:var(--muted);margin-bottom:2rem}

/* Timeline */
.timeline{position:relative;padding-left:2rem}
.timeline::before{content:'';position:absolute;left:7px;top:0;bottom:0;width:2px;background:rgba(255,255,255,0.06)}
.timeline-item{position:relative;margin-bottom:1.5rem;animation:fadeInUp 0.4s ease}
.timeline-dot{position:absolute;left:-2rem;top:0.5rem;width:14px;height:14px;border-radius:50%;background:var(--blue);border:2px solid var(--bg)}
.timeline-date{font-size:0.75rem;color:var(--muted);margin-bottom:0.25rem}
.timeline-title{font-weight:600;margin-bottom:0.25rem}
.timeline-desc{font-size:0.85rem;color:var(--muted)}

/* Revenue gauge */
.gauge-container{display:flex;flex-direction:column;align-items:center;padding:2rem}
.gauge-svg{width:220px;height:220px}
.gauge-text{font-size:2.2rem;font-weight:800}
.gauge-label{color:var(--muted);font-size:0.85rem;margin-top:0.5rem}

/* Bar chart */
.bar-chart{display:flex;align-items:flex-end;gap:1rem;height:200px;padding:1rem 0;border-bottom:1px solid var(--border)}
.bar-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:0.5rem}
.bar{width:100%;max-width:60px;background:linear-gradient(180deg,var(--blue),rgba(59,130,246,0.3));border-radius:6px 6px 0 0;transition:height 0.5s ease;min-height:2px}
.bar-label{font-size:0.7rem;color:var(--muted)}
.bar-value{font-size:0.7rem;font-weight:600;color:var(--text)}

/* Table */
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:0.75rem 1rem;text-align:left;border-bottom:1px solid var(--border);font-size:0.85rem}
th{color:var(--muted);font-weight:600;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em}
tr:hover td{background:rgba(255,255,255,0.02)}

/* Agent cards */
.agent-card{cursor:pointer;position:relative}
.agent-status{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:0.5rem}
.agent-status.online{background:var(--green);animation:pulse 2s infinite}
.agent-status.busy{background:var(--yellow);animation:pulse 2s infinite}
.agent-status.offline{background:var(--gray)}
.agent-name{font-size:1.1rem;font-weight:700;display:flex;align-items:center}
.agent-role{font-size:0.8rem;color:var(--muted);margin-top:0.25rem}
.agent-model{font-size:0.75rem;color:var(--blue);margin-top:0.5rem}
.agent-last{font-size:0.7rem;color:var(--gray);margin-top:0.25rem}

/* Slide-out panel */
.panel-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:200;opacity:0;pointer-events:none;transition:opacity 0.3s ease}
.panel-overlay.open{opacity:1;pointer-events:auto}
.slide-panel{position:fixed;top:0;right:-480px;width:480px;max-width:90vw;height:100vh;background:rgba(10,10,20,0.95);
  backdrop-filter:blur(30px);border-left:1px solid var(--border);z-index:201;transition:right 0.3s ease;overflow-y:auto;padding:2rem}
.slide-panel.open{right:0}
.panel-close{position:absolute;top:1rem;right:1rem;background:none;border:none;color:var(--muted);font-size:1.5rem;cursor:pointer}
.panel-close:hover{color:#fff}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:300;display:none;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:rgba(15,15,30,0.98);backdrop-filter:blur(30px);border:1px solid var(--border);border-radius:var(--radius);padding:2rem;width:500px;max-width:90vw;animation:fadeInUp 0.3s ease}
.modal-title{font-size:1.1rem;font-weight:700;margin-bottom:1.5rem}

/* Meetings */
.meeting-today{border:1px solid rgba(59,130,246,0.3);box-shadow:0 0 20px rgba(59,130,246,0.1)}
.countdown{font-size:0.8rem;color:var(--blue);font-weight:600;margin-top:0.5rem}
.meeting-past{opacity:0.5}
.checklist-item{display:flex;align-items:center;gap:0.5rem;padding:0.3rem 0;font-size:0.85rem}
.checklist-item input[type=checkbox]{accent-color:var(--blue)}
.action-item{display:flex;align-items:center;gap:0.5rem;padding:0.3rem 0;font-size:0.85rem}
.expandable{overflow:hidden;max-height:0;transition:max-height 0.4s ease,padding 0.3s ease;padding:0 1.5rem}
.expandable.open{max-height:2000px;padding:1rem 1.5rem 1.5rem}

/* Search */
.search-input{max-width:400px;margin-bottom:1.5rem}

/* Filter bar */
.filter-bar{display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1.5rem;align-items:center}
.filter-bar .form-select{width:auto;min-width:160px}

/* Daily brief */
.daily-brief{background:linear-gradient(135deg,rgba(59,130,246,0.05),rgba(139,92,246,0.03));border:1px solid rgba(59,130,246,0.15);border-radius:var(--radius);padding:2rem;margin-bottom:2rem}

/* Collapsible */
.collapsible-header{cursor:pointer;display:flex;align-items:center;justify-content:space-between;padding:1rem 0;border-top:1px solid var(--border);margin-top:2rem}
.collapsible-header .arrow{transition:transform 0.3s ease;font-size:0.8rem;color:var(--muted)}
.collapsible-header.open .arrow{transform:rotate(180deg)}
.collapsible-body{max-height:0;overflow:hidden;transition:max-height 0.4s ease}
.collapsible-body.open{max-height:10000px}

/* Responsive */
@media(max-width:768px){
  .header{padding:0 1rem;gap:0.5rem}
  .header-brand{font-size:1rem}
  .tab-btn{font-size:0.7rem;padding:0.4rem 0.5rem}
  .main{padding:1.5rem 1rem}
  .stats-grid{grid-template-columns:repeat(2,1fr)}
  .card-grid{grid-template-columns:1fr}
  .welcome{font-size:1.3rem}
  .bar-chart{gap:0.5rem}
}
@media(max-width:480px){
  .stats-grid{grid-template-columns:1fr}
  .filter-bar{flex-direction:column}
}

/* Tags */
.tag{display:inline-block;padding:0.15rem 0.5rem;border-radius:6px;font-size:0.7rem;font-weight:500;background:rgba(59,130,246,0.1);color:var(--blue);margin:0.15rem}
.activity-log{max-height:200px;overflow-y:auto;font-size:0.8rem}
.activity-log li{padding:0.35rem 0;border-bottom:1px solid var(--border);color:var(--muted)}
.activity-log li .log-time{color:var(--blue);font-weight:500;margin-right:0.5rem}

/* Quick actions */
.quick-actions{display:flex;gap:1rem;flex-wrap:wrap;margin-top:1.5rem}
.quick-action{padding:1rem 1.5rem;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid var(--border);
  cursor:pointer;transition:var(--transition);font-size:0.9rem;font-weight:500}
.quick-action:hover{border-color:rgba(59,130,246,0.3);box-shadow:0 0 15px rgba(59,130,246,0.1)}

/* Projections */
.proj-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-top:1rem}
.proj-item{text-align:center;padding:1rem}
.proj-value{font-size:1.5rem;font-weight:800;color:var(--blue)}
.proj-label{font-size:0.75rem;color:var(--muted);margin-top:0.25rem}
</style>
</head>
<body>

<header class="header">
  <div class="header-brand">‚öîÔ∏è Mission Control</div>
  <nav class="header-tabs" id="tabNav"></nav>
  <div class="status-dot" title="System Online"></div>
</header>

<main class="main" id="mainContent"></main>

<!-- Slide-out Agent Panel -->
<div class="panel-overlay" id="panelOverlay" onclick="closePanel()"></div>
<div class="slide-panel" id="slidePanel">
  <button class="panel-close" onclick="closePanel()">‚úï</button>
  <div id="panelContent"></div>
</div>

<!-- Task Modal -->
<div class="modal-overlay" id="taskModal">
  <div class="modal">
    <div class="modal-title">üì° Send Task to <span id="taskAgentName"></span></div>
    <div class="form-group"><label>Task Description</label><textarea class="form-textarea" id="taskText" rows="4" placeholder="Describe the task..."></textarea></div>
    <div class="form-group"><label>Priority</label><select class="form-select" id="taskPriority"><option value="high">High</option><option value="medium" selected>Medium</option><option value="low">Low</option></select></div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="submitTask()">Submit Task</button>
      <button class="btn btn-ghost" onclick="closeTaskModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
// ===== DATA LAYER =====
const LS={
  get(k,d){try{const v=localStorage.getItem('mc_'+k);return v?JSON.parse(v):d}catch{return d}},
  set(k,v){localStorage.setItem('mc_'+k,JSON.stringify(v))},
};

function initData(){
  if(!LS.get('projects'))LS.set('projects',[]);
  if(!LS.get('timeline'))LS.set('timeline',[]);
  if(!LS.get('notes'))LS.set('notes',[]);
  if(!LS.get('clients'))LS.set('clients',[]);
  if(!LS.get('revenue_history'))LS.set('revenue_history',[]);
  if(!LS.get('meetings'))LS.set('meetings',[]);
  if(!LS.get('decisions'))LS.set('decisions',[]);
  if(!LS.get('intel'))LS.set('intel',defaultIntel());
  if(!LS.get('agents'))LS.set('agents',defaultAgents());
}

function defaultAgents(){
  const now=new Date().toISOString();
  return [
    {id:genId(),name:'Ares',role:'Master Control',status:'online',model:'Claude Opus 4.6',desc:'Strategic command and operations ‚Äî the brain of the operation.',capabilities:['Strategy','Operations','Planning','Analysis','Communication'],lastActive:now,activityLog:[{time:now,text:'System initialized'}],perfNotes:''},
    {id:genId(),name:'Codex',role:'Code Engineer',status:'busy',model:'GPT-5.2 Codex',desc:'Code generation, review, and architecture. Handles all engineering tasks.',capabilities:['Code Generation','Code Review','Architecture','Debugging','DevOps'],lastActive:now,activityLog:[{time:now,text:'Working on dashboard build'}],perfNotes:''},
    {id:genId(),name:'Scout',role:'Research Analyst',status:'online',model:'Claude Sonnet',desc:'Web research and intelligence gathering. Finds what others miss.',capabilities:['Web Research','OSINT','Market Analysis','Report Generation','Trend Analysis'],lastActive:now,activityLog:[{time:now,text:'Monitoring feeds'}],perfNotes:''},
    {id:genId(),name:'Sentinel',role:'Security Monitor',status:'offline',model:'Custom',desc:'24/7 security monitoring and threat detection across all systems.',capabilities:['Threat Detection','Log Analysis','Vulnerability Scanning','Incident Response','Compliance Audit'],lastActive:now,activityLog:[{time:now,text:'Offline ‚Äî maintenance window'}],perfNotes:''},
  ];
}

function defaultIntel(){
  const d=new Date();
  return [
    {id:genId(),title:'CMMC 2.0 Final Rule Updates',summary:'The DoD has released updated guidance on CMMC 2.0 Level 2 assessment requirements. Key changes include streamlined evidence collection and new reciprocity agreements with FedRAMP.',source:'https://www.defense.gov/cmmc',category:'CMMC News',importance:'hot',date:new Date(d-86400000).toISOString()},
    {id:genId(),title:'Ransomware Attacks Up 40% in Q1 2026',summary:'A new report from CrowdStrike shows ransomware incidents increased 40% year-over-year, with SMBs being the primary target. Average ransom demand now exceeds $1.2M.',source:'https://www.crowdstrike.com/reports',category:'Industry Trends',importance:'hot',date:new Date(d-172800000).toISOString()},
    {id:genId(),title:'CompetitorX Launches MSP Division',summary:'CompetitorX announced a new Managed Security Provider division targeting DoD contractors in the DMV area. They are pricing aggressively at $2K/mo for basic CMMC compliance packages.',source:'https://competitorx.com/news',category:'Competitor Watch',importance:'notable',date:new Date(d-259200000).toISOString()},
    {id:genId(),title:'VA State Cybersecurity Grant Program Opening',summary:'Virginia is opening applications for its $5M cybersecurity small business grant program. Eligible businesses can receive up to $50K for compliance and security improvements.',source:'https://www.virginia.gov/grants',category:'Opportunities',importance:'notable',date:new Date(d-345600000).toISOString()},
  ];
}

function genId(){return Date.now().toString(36)+Math.random().toString(36).slice(2,7)}
function fmtDate(d){return new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}
function fmtDateTime(d){return new Date(d).toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'})}
function fmtMoney(n){return '$'+Number(n).toLocaleString('en-US')}
function getGreeting(){const h=new Date().getHours();return h<12?'morning':h<17?'afternoon':'evening'}
function isToday(d){const t=new Date(),dd=new Date(d);return t.toDateString()===dd.toDateString()}
function isPast(d){return new Date(d)<new Date()&&!isToday(d)}

// ===== TABS =====
const tabs=[
  {id:'dashboard',icon:'üìä',label:'Dashboard'},
  {id:'projects',icon:'üìã',label:'Projects'},
  {id:'timeline',icon:'üéØ',label:'Timeline'},
  {id:'notes',icon:'üìù',label:'Notes'},
  {id:'revenue',icon:'üí∞',label:'Revenue'},
  {id:'command',icon:'üè¢',label:'Command Center'},
  {id:'meetings',icon:'üìû',label:'Meetings'},
  {id:'intel',icon:'üì°',label:'Intel'},
];

let activeTab='dashboard';
let currentTaskAgent=null;

function renderTabs(){
  const nav=document.getElementById('tabNav');
  nav.innerHTML=tabs.map(t=>`<button class="tab-btn${t.id===activeTab?' active':''}" onclick="switchTab('${t.id}')">${t.icon} ${t.label}</button>`).join('');
}

function switchTab(id){
  activeTab=id;
  renderTabs();
  renderContent();
}

// ===== MAIN RENDER =====
function renderContent(){
  const el=document.getElementById('mainContent');
  const renderers={dashboard:renderDashboard,projects:renderProjects,timeline:renderTimeline,notes:renderNotes,revenue:renderRevenue,command:renderCommand,meetings:renderMeetings,intel:renderIntel};
  el.innerHTML=`<div class="tab-content active">${(renderers[activeTab]||renderers.dashboard)()}</div>`;
  if(activeTab==='meetings')startCountdowns();
}

// ===== DASHBOARD =====
function renderDashboard(){
  const projects=LS.get('projects',[]);
  const notes=LS.get('notes',[]);
  const clients=LS.get('clients',[]);
  const mrr=clients.filter(c=>c.status==='active').reduce((s,c)=>s+Number(c.value||0),0);
  const tasksDue=projects.filter(p=>p.status==='active').length;
  return `
    <div class="welcome">Good ${getGreeting()}, Commander</div>
    <div class="welcome-sub">Capital Cyber Mission Control ‚Äî All systems operational</div>
    <div class="stats-grid">
      <div class="card stat-card"><div class="stat-value">${fmtMoney(mrr)}</div><div class="stat-label">Current MRR</div></div>
      <div class="card stat-card"><div class="stat-value">${projects.length}</div><div class="stat-label">Active Projects</div></div>
      <div class="card stat-card"><div class="stat-value">${tasksDue}</div><div class="stat-label">Tasks Due</div></div>
      <div class="card stat-card"><div class="stat-value">${notes.length}</div><div class="stat-label">Notes</div></div>
    </div>
    <div class="section-title">‚ö° Quick Actions</div>
    <div class="quick-actions">
      <div class="quick-action" onclick="switchTab('projects')">üìã New Project</div>
      <div class="quick-action" onclick="switchTab('revenue')">üí∞ Add Client</div>
      <div class="quick-action" onclick="switchTab('meetings')">üìû Schedule Meeting</div>
      <div class="quick-action" onclick="switchTab('intel')">üì° Intel Feed</div>
      <div class="quick-action" onclick="switchTab('command')">üè¢ Command Center</div>
    </div>`;
}

// ===== PROJECTS =====
let showProjectForm=false,editProjectId=null;
function renderProjects(){
  const projects=LS.get('projects',[]);
  let html=`<div class="section-title">üìã Projects</div>
    <button class="btn btn-primary" onclick="showProjectForm=!showProjectForm;editProjectId=null;renderContent()">+ Add Project</button>`;
  if(showProjectForm)html+=projectForm(editProjectId?projects.find(p=>p.id===editProjectId):null);
  html+='<div class="card-grid" style="margin-top:1.5rem">'+projects.map(p=>`
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:start">
        <div><div style="font-weight:700;font-size:1.05rem">${esc(p.name)}</div>
        <span class="badge badge-${p.status}" style="margin-top:0.5rem">${p.status}</span>
        <span class="badge badge-${p.priority}">${p.priority}</span></div>
      </div>
      <p style="color:var(--muted);font-size:0.85rem;margin-top:0.75rem">${esc(p.description||'')}</p>
      <div style="font-size:0.7rem;color:var(--gray);margin-top:0.5rem">Started ${fmtDate(p.startDate)}</div>
      <div class="btn-row">
        <button class="btn btn-ghost btn-sm" onclick="editProject('${p.id}')">Edit</button>
        <button class="btn btn-danger btn-sm" onclick="deleteProject('${p.id}')">Delete</button>
      </div>
    </div>`).join('')+'</div>';
  return html;
}
function projectForm(p){
  return `<div class="inline-form" style="margin-top:1rem">
    <div class="form-group"><label>Project Name</label><input class="form-input" id="pName" value="${esc(p?.name||'')}"></div>
    <div class="form-group"><label>Description</label><textarea class="form-textarea" id="pDesc">${esc(p?.description||'')}</textarea></div>
    <div style="display:flex;gap:1rem">
      <div class="form-group" style="flex:1"><label>Status</label><select class="form-select" id="pStatus">
        ${['active','paused','completed'].map(s=>`<option ${p?.status===s?'selected':''}>${s}</option>`).join('')}</select></div>
      <div class="form-group" style="flex:1"><label>Priority</label><select class="form-select" id="pPriority">
        ${['high','medium','low'].map(s=>`<option ${p?.priority===s?'selected':''}>${s}</option>`).join('')}</select></div>
      <div class="form-group" style="flex:1"><label>Start Date</label><input type="date" class="form-input" id="pDate" value="${p?.startDate||new Date().toISOString().slice(0,10)}"></div>
    </div>
    <button class="btn btn-primary" onclick="saveProject()">${p?'Update':'Save'} Project</button>
    <button class="btn btn-ghost" onclick="showProjectForm=false;editProjectId=null;renderContent()" style="margin-left:0.5rem">Cancel</button>
  </div>`;
}
function saveProject(){
  const projects=LS.get('projects',[]);
  const data={name:gv('pName'),description:gv('pDesc'),status:gv('pStatus'),priority:gv('pPriority'),startDate:gv('pDate')};
  if(!data.name)return;
  if(editProjectId){const i=projects.findIndex(p=>p.id===editProjectId);if(i>=0)projects[i]={...projects[i],...data}}
  else projects.unshift({id:genId(),...data});
  LS.set('projects',projects);showProjectForm=false;editProjectId=null;renderContent();
}
function editProject(id){editProjectId=id;showProjectForm=true;renderContent()}
function deleteProject(id){if(!confirm('Delete project?'))return;LS.set('projects',LS.get('projects',[]).filter(p=>p.id!==id));renderContent()}

// ===== TIMELINE =====
let showTimelineForm=false;
function renderTimeline(){
  const events=LS.get('timeline',[]).sort((a,b)=>new Date(b.date)-new Date(a.date));
  let html=`<div class="section-title">üéØ Timeline</div>
    <button class="btn btn-primary" onclick="showTimelineForm=!showTimelineForm;renderContent()">+ Add Event</button>`;
  if(showTimelineForm)html+=`<div class="inline-form" style="margin-top:1rem">
    <div class="form-group"><label>Date</label><input type="date" class="form-input" id="tDate" value="${new Date().toISOString().slice(0,10)}"></div>
    <div class="form-group"><label>Title</label><input class="form-input" id="tTitle"></div>
    <div class="form-group"><label>Description</label><textarea class="form-textarea" id="tDesc"></textarea></div>
    <button class="btn btn-primary" onclick="saveTimelineEvent()">Save</button>
    <button class="btn btn-ghost" onclick="showTimelineForm=false;renderContent()" style="margin-left:0.5rem">Cancel</button>
  </div>`;
  html+='<div class="timeline" style="margin-top:1.5rem">'+events.map(e=>`
    <div class="timeline-item">
      <div class="timeline-dot"></div>
      <div class="timeline-date">${fmtDate(e.date)}</div>
      <div class="timeline-title">${esc(e.title)}</div>
      <div class="timeline-desc">${esc(e.description||'')}</div>
      <button class="btn btn-danger btn-sm" style="margin-top:0.5rem" onclick="deleteTimeline('${e.id}')">Delete</button>
    </div>`).join('')+'</div>';
  return html;
}
function saveTimelineEvent(){
  const events=LS.get('timeline',[]);
  const data={id:genId(),date:gv('tDate'),title:gv('tTitle'),description:gv('tDesc')};
  if(!data.title)return;events.unshift(data);LS.set('timeline',events);showTimelineForm=false;renderContent();
}
function deleteTimeline(id){LS.set('timeline',LS.get('timeline',[]).filter(e=>e.id!==id));renderContent()}

// ===== NOTES =====
let showNoteForm=false,editNoteId=null;
function renderNotes(){
  const notes=LS.get('notes',[]);
  let html=`<div class="section-title">üìù Notes</div>
    <input class="form-input search-input" placeholder="üîç Search notes..." oninput="window._noteSearch=this.value;renderContent()" value="${esc(window._noteSearch||'')}">
    <button class="btn btn-primary" onclick="showNoteForm=!showNoteForm;editNoteId=null;renderContent()">+ Add Note</button>`;
  if(showNoteForm){
    const n=editNoteId?notes.find(x=>x.id===editNoteId):null;
    html+=`<div class="inline-form" style="margin-top:1rem">
      <div class="form-group"><label>Title</label><input class="form-input" id="nTitle" value="${esc(n?.title||'')}"></div>
      <div class="form-group"><label>Content</label><textarea class="form-textarea" id="nContent" rows="5">${esc(n?.content||'')}</textarea></div>
      <button class="btn btn-primary" onclick="saveNote()">${n?'Update':'Save'}</button>
      <button class="btn btn-ghost" onclick="showNoteForm=false;editNoteId=null;renderContent()" style="margin-left:0.5rem">Cancel</button>
    </div>`;
  }
  const q=(window._noteSearch||'').toLowerCase();
  const filtered=notes.filter(n=>!q||n.title.toLowerCase().includes(q)||n.content.toLowerCase().includes(q));
  html+='<div class="card-grid" style="margin-top:1.5rem">'+filtered.map(n=>`
    <div class="card">
      <div style="font-weight:700">${esc(n.title)}</div>
      <p style="color:var(--muted);font-size:0.85rem;margin-top:0.5rem;white-space:pre-wrap">${esc(n.content.slice(0,300))}${n.content.length>300?'...':''}</p>
      <div style="font-size:0.7rem;color:var(--gray);margin-top:0.5rem">${fmtDateTime(n.date)}</div>
      <div class="btn-row">
        <button class="btn btn-ghost btn-sm" onclick="editNoteId='${n.id}';showNoteForm=true;renderContent()">Edit</button>
        <button class="btn btn-danger btn-sm" onclick="deleteNote('${n.id}')">Delete</button>
      </div>
    </div>`).join('')+'</div>';
  return html;
}
function saveNote(){
  const notes=LS.get('notes',[]);
  const data={title:gv('nTitle'),content:gv('nContent')};if(!data.title)return;
  if(editNoteId){const i=notes.findIndex(n=>n.id===editNoteId);if(i>=0)notes[i]={...notes[i],...data}}
  else notes.unshift({id:genId(),...data,date:new Date().toISOString()});
  LS.set('notes',notes);showNoteForm=false;editNoteId=null;renderContent();
}
function deleteNote(id){LS.set('notes',LS.get('notes',[]).filter(n=>n.id!==id));renderContent()}

// ===== REVENUE =====
let showClientForm=false,editClientId=null;
function renderRevenue(){
  const clients=LS.get('clients',[]);
  const mrr=clients.filter(c=>c.status==='active').reduce((s,c)=>s+Number(c.value||0),0);
  const goal=50000;const pct=Math.min((mrr/goal)*100,100);
  const history=LS.get('revenue_history',[]).slice(-6);
  const maxHist=Math.max(...history.map(h=>h.value),1);

  // Projections
  const now=new Date();const target=new Date(2026,11,31);
  const monthsLeft=Math.max(1,Math.round((target-now)/(30.44*86400000)));
  const needed=mrr<goal?Math.ceil((goal-mrr)/monthsLeft):0;
  const annualProj=mrr*12;

  // Gauge SVG
  const r=90,c=2*Math.PI*r,offset=c-(pct/100)*c;
  const gauge=`<svg class="gauge-svg" viewBox="0 0 220 220">
    <circle cx="110" cy="110" r="${r}" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="14"/>
    <circle cx="110" cy="110" r="${r}" fill="none" stroke="url(#gGrad)" stroke-width="14" stroke-linecap="round"
      stroke-dasharray="${c}" stroke-dashoffset="${offset}" transform="rotate(-90 110 110)" style="transition:stroke-dashoffset 1s ease"/>
    <defs><linearGradient id="gGrad" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#3b82f6"/><stop offset="100%" stop-color="#8b5cf6"/></linearGradient></defs>
    <text x="110" y="105" text-anchor="middle" fill="#fff" font-size="28" font-weight="800" font-family="Inter">${fmtMoney(mrr)}</text>
    <text x="110" y="130" text-anchor="middle" fill="#94a3b8" font-size="12" font-family="Inter">of ${fmtMoney(goal)} goal</text>
  </svg>`;

  let html=`<div class="section-title">üí∞ Revenue</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem">
      <div class="card"><div class="gauge-container">${gauge}<div class="gauge-label">${pct.toFixed(1)}% of goal</div></div></div>
      <div class="card"><div class="section-title" style="font-size:1rem;margin-bottom:1rem">üìà Projections</div>
        <div class="proj-grid">
          <div class="proj-item"><div class="proj-value">${fmtMoney(annualProj)}</div><div class="proj-label">Projected Annual</div></div>
          <div class="proj-item"><div class="proj-value">${fmtMoney(needed)}/mo</div><div class="proj-label">Growth Needed</div></div>
          <div class="proj-item"><div class="proj-value">${monthsLeft}</div><div class="proj-label">Months Left</div></div>
          <div class="proj-item"><div class="proj-value">${pct.toFixed(0)}%</div><div class="proj-label">Goal Progress</div></div>
        </div>
      </div>
    </div>`;

  // Bar chart
  html+=`<div class="card" style="margin-bottom:1.5rem"><div class="section-title" style="font-size:1rem;margin-bottom:1rem">üìä Revenue History (Last 6 Months)</div>`;
  if(history.length===0)html+='<p style="color:var(--muted);font-size:0.85rem">No history yet. MRR is snapshotted when you add/edit clients.</p>';
  else html+='<div class="bar-chart">'+history.map(h=>{
    const hPct=Math.max((h.value/maxHist)*160,4);
    return `<div class="bar-col"><div class="bar-value">${fmtMoney(h.value)}</div><div class="bar" style="height:${hPct}px"></div><div class="bar-label">${h.month}</div></div>`;
  }).join('')+'</div>';
  html+='</div>';

  // Clients
  html+=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
    <div class="section-title" style="margin:0">üë• Clients</div>
    <button class="btn btn-primary" onclick="showClientForm=!showClientForm;editClientId=null;renderContent()">+ Add Client</button>
  </div>`;
  if(showClientForm){
    const c=editClientId?clients.find(x=>x.id===editClientId):null;
    html+=`<div class="inline-form">
      <div style="display:flex;gap:1rem;flex-wrap:wrap">
        <div class="form-group" style="flex:2;min-width:180px"><label>Name</label><input class="form-input" id="cName" value="${esc(c?.name||'')}"></div>
        <div class="form-group" style="flex:1;min-width:120px"><label>Monthly Value ($)</label><input type="number" class="form-input" id="cValue" value="${c?.value||''}"></div>
        <div class="form-group" style="flex:1;min-width:120px"><label>Status</label><select class="form-select" id="cStatus">
          ${['active','pending','churned'].map(s=>`<option ${c?.status===s?'selected':''}>${s}</option>`).join('')}</select></div>
        <div class="form-group" style="flex:1;min-width:120px"><label>Start Date</label><input type="date" class="form-input" id="cDate" value="${c?.startDate||new Date().toISOString().slice(0,10)}"></div>
      </div>
      <button class="btn btn-primary" onclick="saveClient()">${c?'Update':'Save'}</button>
      <button class="btn btn-ghost" onclick="showClientForm=false;editClientId=null;renderContent()" style="margin-left:0.5rem">Cancel</button>
    </div>`;
  }
  html+=`<div class="card"><div class="table-wrap"><table>
    <thead><tr><th>Name</th><th>Monthly Value</th><th>Status</th><th>Start Date</th><th>Actions</th></tr></thead>
    <tbody>${clients.length===0?'<tr><td colspan="5" style="color:var(--muted);text-align:center;padding:2rem">No clients yet ‚Äî add your first client above</td></tr>':''}
    ${clients.map(c=>`<tr>
      <td style="font-weight:600">${esc(c.name)}</td><td>${fmtMoney(c.value)}</td>
      <td><span class="badge badge-${c.status}">${c.status}</span></td><td>${fmtDate(c.startDate)}</td>
      <td><button class="btn btn-ghost btn-sm" onclick="editClientId='${c.id}';showClientForm=true;renderContent()">Edit</button>
        <button class="btn btn-danger btn-sm" onclick="deleteClient('${c.id}')">Delete</button></td>
    </tr>`).join('')}</tbody></table></div></div>`;
  return html;
}
function saveClient(){
  const clients=LS.get('clients',[]);
  const data={name:gv('cName'),value:Number(gv('cValue'))||0,status:gv('cStatus'),startDate:gv('cDate')};
  if(!data.name)return;
  if(editClientId){const i=clients.findIndex(c=>c.id===editClientId);if(i>=0)clients[i]={...clients[i],...data}}
  else clients.unshift({id:genId(),...data});
  LS.set('clients',clients);showClientForm=false;editClientId=null;
  snapshotRevenue(clients);renderContent();
}
function deleteClient(id){if(!confirm('Delete client?'))return;const c=LS.get('clients',[]).filter(x=>x.id!==id);LS.set('clients',c);snapshotRevenue(c);renderContent()}
function snapshotRevenue(clients){
  const mrr=clients.filter(c=>c.status==='active').reduce((s,c)=>s+Number(c.value||0),0);
  const hist=LS.get('revenue_history',[]);
  const month=new Date().toLocaleDateString('en-US',{month:'short',year:'2-digit'});
  const existing=hist.findIndex(h=>h.month===month);
  if(existing>=0)hist[existing].value=mrr;else hist.push({month,value:mrr});
  LS.set('revenue_history',hist.slice(-12));
}

// ===== COMMAND CENTER =====
let showDecisionForm=false,editDecisionId=null;
function renderCommand(){
  const agents=LS.get('agents',[]);
  const decisions=LS.get('decisions',[]);
  let html=`<div class="section-title">üè¢ Command Center</div>
    <div class="section-sub">AI Agent Fleet Management & Executive Decisions</div>
    <div class="card-grid">${agents.map(a=>`
      <div class="card agent-card" onclick="openAgentPanel('${a.id}')">
        <div class="agent-name"><span class="agent-status ${a.status}"></span>${esc(a.name)}</div>
        <div class="agent-role">${esc(a.role)}</div>
        <div class="agent-model">ü§ñ ${esc(a.model)}</div>
        <div class="agent-last">Last active: ${fmtDateTime(a.lastActive)}</div>
        <div class="btn-row">
          <button class="btn btn-primary btn-sm" onclick="event.stopPropagation();openTaskModal('${a.id}')">üì° Send Task</button>
        </div>
      </div>`).join('')}</div>`;

  // Decisions
  html+=`<div style="margin-top:3rem"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
    <div class="section-title" style="margin:0">‚öñÔ∏è Executive Decisions</div>
    <button class="btn btn-primary" onclick="showDecisionForm=!showDecisionForm;editDecisionId=null;renderContent()">+ Add Decision</button>
  </div>`;
  if(showDecisionForm){
    const d=editDecisionId?decisions.find(x=>x.id===editDecisionId):null;
    html+=`<div class="inline-form">
      <div class="form-group"><label>Question / Topic</label><input class="form-input" id="dTopic" value="${esc(d?.topic||'')}"></div>
      <div class="form-group"><label>Decision Summary</label><textarea class="form-textarea" id="dSummary">${esc(d?.summary||'')}</textarea></div>
      <div class="form-group"><label>Agents Consulted</label>
        <div style="display:flex;gap:1rem;flex-wrap:wrap">${agents.map(a=>`<label style="font-size:0.85rem;display:flex;align-items:center;gap:0.35rem">
          <input type="checkbox" class="dAgent" value="${a.name}" ${d?.agents?.includes(a.name)?'checked':''}> ${a.name}</label>`).join('')}</div></div>
      <button class="btn btn-primary" onclick="saveDecision()">${d?'Update':'Save'}</button>
      <button class="btn btn-ghost" onclick="showDecisionForm=false;editDecisionId=null;renderContent()" style="margin-left:0.5rem">Cancel</button>
    </div>`;
  }
  html+=decisions.map(d=>`<div class="card" style="margin-bottom:1rem">
    <div style="display:flex;justify-content:space-between;align-items:start">
      <div><div style="font-weight:700">${esc(d.topic)}</div>
        <p style="color:var(--muted);font-size:0.85rem;margin-top:0.5rem">${esc(d.summary)}</p>
        <div style="margin-top:0.5rem">${(d.agents||[]).map(a=>`<span class="tag">${esc(a)}</span>`).join('')}</div>
        <div style="font-size:0.7rem;color:var(--gray);margin-top:0.5rem">${fmtDate(d.date)}</div>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-ghost btn-sm" onclick="editDecisionId='${d.id}';showDecisionForm=true;renderContent()">Edit</button>
      <button class="btn btn-danger btn-sm" onclick="deleteDecision('${d.id}')">Delete</button>
    </div>
  </div>`).join('')+'</div>';
  return html;
}
function saveDecision(){
  const decisions=LS.get('decisions',[]);
  const agents=[...document.querySelectorAll('.dAgent:checked')].map(c=>c.value);
  const data={topic:gv('dTopic'),summary:gv('dSummary'),agents};if(!data.topic)return;
  if(editDecisionId){const i=decisions.findIndex(d=>d.id===editDecisionId);if(i>=0)decisions[i]={...decisions[i],...data}}
  else decisions.unshift({id:genId(),...data,date:new Date().toISOString()});
  LS.set('decisions',decisions);showDecisionForm=false;editDecisionId=null;renderContent();
}
function deleteDecision(id){LS.set('decisions',LS.get('decisions',[]).filter(d=>d.id!==id));renderContent()}

// Agent panel
function openAgentPanel(id){
  const a=LS.get('agents',[]).find(x=>x.id===id);if(!a)return;
  document.getElementById('panelOverlay').classList.add('open');
  document.getElementById('slidePanel').classList.add('open');
  document.getElementById('panelContent').innerHTML=`
    <div class="agent-name" style="font-size:1.4rem;margin-bottom:0.25rem"><span class="agent-status ${a.status}"></span>${esc(a.name)}</div>
    <div class="agent-role" style="font-size:1rem">${esc(a.role)}</div>
    <div class="agent-model" style="margin:0.75rem 0">ü§ñ ${esc(a.model)}</div>
    <span class="badge badge-${a.status}">${a.status}</span>
    <p style="color:var(--muted);margin-top:1.25rem;font-size:0.9rem;line-height:1.6">${esc(a.desc)}</p>
    <div style="margin-top:1.5rem"><div style="font-weight:600;margin-bottom:0.75rem">üè∑Ô∏è Capabilities</div>
      <div>${(a.capabilities||[]).map(c=>`<span class="tag">${esc(c)}</span>`).join('')}</div></div>
    <div style="margin-top:1.5rem"><div style="font-weight:600;margin-bottom:0.75rem">üìú Recent Activity</div>
      <ul class="activity-log">${(a.activityLog||[]).slice(0,20).map(l=>`<li><span class="log-time">${fmtDateTime(l.time)}</span>${esc(l.text)}</li>`).join('')}</ul></div>
    <div style="margin-top:1.5rem"><div style="font-weight:600;margin-bottom:0.75rem">üìù Performance Notes</div>
      <textarea class="form-textarea" id="perfNotes" onchange="savePerfNotes('${a.id}',this.value)">${esc(a.perfNotes||'')}</textarea></div>`;
}
function closePanel(){document.getElementById('panelOverlay').classList.remove('open');document.getElementById('slidePanel').classList.remove('open')}
function savePerfNotes(id,val){const agents=LS.get('agents',[]);const a=agents.find(x=>x.id===id);if(a){a.perfNotes=val;LS.set('agents',agents)}}

// Task modal
function openTaskModal(id){
  const a=LS.get('agents',[]).find(x=>x.id===id);if(!a)return;
  currentTaskAgent=id;
  document.getElementById('taskAgentName').textContent=a.name;
  document.getElementById('taskText').value='';
  document.getElementById('taskPriority').value='medium';
  document.getElementById('taskModal').classList.add('open');
}
function closeTaskModal(){document.getElementById('taskModal').classList.remove('open');currentTaskAgent=null}
function submitTask(){
  if(!currentTaskAgent)return;
  const text=gv('taskText');const priority=gv('taskPriority');if(!text)return;
  const agents=LS.get('agents',[]);const a=agents.find(x=>x.id===currentTaskAgent);
  if(a){
    a.activityLog.unshift({time:new Date().toISOString(),text:`[${priority.toUpperCase()}] ${text}`});
    a.lastActive=new Date().toISOString();
    LS.set('agents',agents);
  }
  closeTaskModal();renderContent();
}

// ===== MEETINGS =====
let showMeetingForm=false,editMeetingId=null,expandedMeeting=null,showArchive=false;
function renderMeetings(){
  const meetings=LS.get('meetings',[]);
  const today=[],upcoming=[],past=[];
  meetings.forEach(m=>{
    const dt=new Date(m.date+'T'+(m.time||'00:00'));
    if(isToday(dt))today.push(m);
    else if(isPast(dt))past.push(m);
    else upcoming.push(m);
  });
  today.sort((a,b)=>(a.time||'').localeCompare(b.time||''));
  upcoming.sort((a,b)=>new Date(a.date+'T'+(a.time||'00:00'))-new Date(b.date+'T'+(b.time||'00:00')));
  past.sort((a,b)=>new Date(b.date)-new Date(a.date));

  let html=`<div class="section-title">üìû Meetings</div>
    <button class="btn btn-primary" onclick="showMeetingForm=!showMeetingForm;editMeetingId=null;renderContent()">+ Add Meeting</button>`;
  if(showMeetingForm){
    const m=editMeetingId?meetings.find(x=>x.id===editMeetingId):null;
    html+=`<div class="inline-form" style="margin-top:1rem">
      <div class="form-group"><label>Title</label><input class="form-input" id="mTitle" value="${esc(m?.title||'')}"></div>
      <div style="display:flex;gap:1rem;flex-wrap:wrap">
        <div class="form-group" style="flex:1;min-width:140px"><label>Date</label><input type="date" class="form-input" id="mDate" value="${m?.date||new Date().toISOString().slice(0,10)}"></div>
        <div class="form-group" style="flex:1;min-width:120px"><label>Time</label><input type="time" class="form-input" id="mTime" value="${m?.time||'09:00'}"></div>
        <div class="form-group" style="flex:1;min-width:140px"><label>Type</label><select class="form-select" id="mType">
          ${['call','zoom','in-person'].map(s=>`<option ${m?.type===s?'selected':''}>${s}</option>`).join('')}</select></div>
      </div>
      <div class="form-group"><label>Attendees (comma-separated)</label><input class="form-input" id="mAttendees" value="${esc(m?.attendees||'')}"></div>
      <div class="form-group"><label>Prep Notes</label><textarea class="form-textarea" id="mPrep">${esc(m?.prep||'')}</textarea></div>
      <button class="btn btn-primary" onclick="saveMeeting()">${m?'Update':'Save'}</button>
      <button class="btn btn-ghost" onclick="showMeetingForm=false;editMeetingId=null;renderContent()" style="margin-left:0.5rem">Cancel</button>
    </div>`;
  }

  // Today
  html+=`<div style="margin-top:2rem"><div class="section-title" style="font-size:1.1rem">üìÖ Today's Meetings</div>`;
  if(today.length===0)html+='<div class="card" style="color:var(--muted);text-align:center;padding:2rem">No meetings scheduled for today</div>';
  else html+=today.map(m=>meetingCard(m,true)).join('');
  html+='</div>';

  // Upcoming
  html+=`<div style="margin-top:2rem"><div class="section-title" style="font-size:1.1rem">üîÆ Upcoming</div>`;
  if(upcoming.length===0)html+='<div class="card" style="color:var(--muted);text-align:center;padding:2rem">No upcoming meetings</div>';
  else html+=upcoming.map(m=>meetingCard(m,false)).join('');
  html+='</div>';

  // Past archive
  html+=`<div class="collapsible-header ${showArchive?'open':''}" onclick="showArchive=!showArchive;renderContent()">
    <div style="font-weight:600;color:var(--muted)">üìÅ Past Meetings (${past.length})</div><span class="arrow">‚ñº</span></div>
    <div class="collapsible-body ${showArchive?'open':''}">
    ${past.length?past.map(m=>`<div class="meeting-past" style="margin-bottom:1rem">${meetingCard(m,false,true)}</div>`).join('')+'<button class="btn btn-danger btn-sm" style="margin-top:1rem" onclick="clearArchive()">Clear Archive</button>':'<p style="color:var(--muted);padding:1rem">No past meetings</p>'}
    </div>`;
  return html;
}

function meetingCard(m,isToday,isPastMeeting){
  const exp=expandedMeeting===m.id;
  const typeBadge=`badge-${m.type==='zoom'?'zoom':m.type==='in-person'?'in-person':'call'}`;
  let html=`<div class="card ${isToday?'meeting-today':''}" style="margin-bottom:1rem">
    <div style="display:flex;justify-content:space-between;align-items:start;cursor:pointer" onclick="expandedMeeting=expandedMeeting==='${m.id}'?null:'${m.id}';renderContent()">
      <div>
        <div style="font-weight:700;font-size:1.05rem">${esc(m.title)}</div>
        <div style="font-size:0.85rem;color:var(--muted);margin-top:0.25rem">${fmtDate(m.date)} at ${m.time||'TBD'} ¬∑ <span class="badge ${typeBadge}">${m.type}</span></div>
        ${m.attendees?`<div style="font-size:0.8rem;color:var(--gray);margin-top:0.25rem">üë• ${esc(m.attendees)}</div>`:''}
        ${m.prep?`<div style="font-size:0.8rem;color:var(--muted);margin-top:0.35rem">${esc(m.prep.slice(0,100))}${m.prep.length>100?'...':''}</div>`:''}
      </div>
      <span style="color:var(--muted);font-size:0.8rem">${exp?'‚ñ≤':'‚ñº'}</span>
    </div>`;
  if(isToday)html+=`<div class="countdown" data-meeting-time="${m.date}T${m.time||'00:00'}"></div>`;
  if(exp){
    const agenda=m.agenda||[];const actions=m.actions||[];
    html+=`<div style="margin-top:1rem;border-top:1px solid var(--border);padding-top:1rem">
      <div style="font-weight:600;font-size:0.85rem;margin-bottom:0.5rem">üìã Agenda</div>
      <div id="agenda-${m.id}">${agenda.map((a,i)=>`<div class="checklist-item">
        <input type="checkbox" ${a.done?'checked':''} onchange="toggleAgenda('${m.id}',${i})">
        <span style="${a.done?'text-decoration:line-through;opacity:0.5':''}">${esc(a.text)}</span>
        <button class="btn btn-danger btn-sm" style="margin-left:auto;padding:0.15rem 0.4rem" onclick="removeAgenda('${m.id}',${i})">‚úï</button>
      </div>`).join('')}</div>
      <div style="display:flex;gap:0.5rem;margin-top:0.5rem">
        <input class="form-input" id="newAgenda-${m.id}" placeholder="Add agenda item..." style="flex:1" onkeydown="if(event.key==='Enter')addAgenda('${m.id}')">
        <button class="btn btn-primary btn-sm" onclick="addAgenda('${m.id}')">Add</button>
      </div>
      <div style="font-weight:600;font-size:0.85rem;margin:1rem 0 0.5rem">üìù Notes</div>
      <textarea class="form-textarea" rows="3" onchange="saveMeetingNotes('${m.id}',this.value)">${esc(m.notes||'')}</textarea>
      <div style="font-weight:600;font-size:0.85rem;margin:1rem 0 0.5rem">‚úÖ Action Items</div>
      ${actions.map((a,i)=>`<div class="action-item">${esc(a.text)} <span style="color:var(--blue);font-size:0.75rem">‚Üí ${esc(a.assignee||'Unassigned')}</span>
        <button class="btn btn-danger btn-sm" style="margin-left:auto;padding:0.15rem 0.4rem" onclick="removeAction('${m.id}',${i})">‚úï</button>
      </div>`).join('')}
      <div style="display:flex;gap:0.5rem;margin-top:0.5rem">
        <input class="form-input" id="newAction-${m.id}" placeholder="Action item..." style="flex:2">
        <input class="form-input" id="newAssignee-${m.id}" placeholder="Assignee" style="flex:1">
        <button class="btn btn-primary btn-sm" onclick="addAction('${m.id}')">Add</button>
      </div>
      <div class="btn-row" style="margin-top:1rem">
        <button class="btn btn-ghost btn-sm" onclick="editMeetingId='${m.id}';showMeetingForm=true;renderContent()">Edit</button>
        <button class="btn btn-danger btn-sm" onclick="deleteMeeting('${m.id}')">Delete</button>
      </div>
    </div>`;
  }
  html+='</div>';
  return html;
}

function saveMeeting(){
  const meetings=LS.get('meetings',[]);
  const data={title:gv('mTitle'),date:gv('mDate'),time:gv('mTime'),type:gv('mType'),attendees:gv('mAttendees'),prep:gv('mPrep')};
  if(!data.title)return;
  if(editMeetingId){const i=meetings.findIndex(m=>m.id===editMeetingId);if(i>=0)meetings[i]={...meetings[i],...data}}
  else meetings.unshift({id:genId(),...data,agenda:[],notes:'',actions:[]});
  LS.set('meetings',meetings);showMeetingForm=false;editMeetingId=null;renderContent();
}
function deleteMeeting(id){if(!confirm('Delete meeting?'))return;LS.set('meetings',LS.get('meetings',[]).filter(m=>m.id!==id));renderContent()}
function clearArchive(){if(!confirm('Clear all past meetings?'))return;const m=LS.get('meetings',[]).filter(x=>!isPast(new Date(x.date+'T'+(x.time||'00:00')))||isToday(new Date(x.date+'T'+(x.time||'00:00'))));LS.set('meetings',m);renderContent()}
function toggleAgenda(mid,idx){const m=LS.get('meetings',[]);const mt=m.find(x=>x.id===mid);if(mt&&mt.agenda[idx]){mt.agenda[idx].done=!mt.agenda[idx].done;LS.set('meetings',m);renderContent()}}
function addAgenda(mid){const el=document.getElementById('newAgenda-'+mid);if(!el||!el.value.trim())return;const m=LS.get('meetings',[]);const mt=m.find(x=>x.id===mid);if(mt){mt.agenda=mt.agenda||[];mt.agenda.push({text:el.value.trim(),done:false});LS.set('meetings',m);renderContent()}}
function removeAgenda(mid,idx){const m=LS.get('meetings',[]);const mt=m.find(x=>x.id===mid);if(mt){mt.agenda.splice(idx,1);LS.set('meetings',m);renderContent()}}
function addAction(mid){const t=document.getElementById('newAction-'+mid);const a=document.getElementById('newAssignee-'+mid);if(!t||!t.value.trim())return;const m=LS.get('meetings',[]);const mt=m.find(x=>x.id===mid);if(mt){mt.actions=mt.actions||[];mt.actions.push({text:t.value.trim(),assignee:a?.value.trim()||''});LS.set('meetings',m);renderContent()}}
function removeAction(mid,idx){const m=LS.get('meetings',[]);const mt=m.find(x=>x.id===mid);if(mt){mt.actions.splice(idx,1);LS.set('meetings',m);renderContent()}}
function saveMeetingNotes(mid,val){const m=LS.get('meetings',[]);const mt=m.find(x=>x.id===mid);if(mt){mt.notes=val;LS.set('meetings',m)}}

function startCountdowns(){
  const els=document.querySelectorAll('.countdown[data-meeting-time]');
  if(!els.length)return;
  function update(){
    els.forEach(el=>{
      const t=new Date(el.dataset.meetingTime)-new Date();
      if(t<=0){el.textContent='‚è∞ Meeting time!';return}
      const h=Math.floor(t/3600000),m=Math.floor((t%3600000)/60000),s=Math.floor((t%60000)/1000);
      el.textContent=`‚è≥ Starts in ${h?h+'h ':''}${m}m ${s}s`;
    });
  }
  update();window._countdownInterval&&clearInterval(window._countdownInterval);window._countdownInterval=setInterval(update,1000);
}

// ===== INTEL =====
let showIntelForm=false,editIntelId=null;
window._intelCat='All';window._intelImp='All';
function renderIntel(){
  const items=LS.get('intel',[]).sort((a,b)=>new Date(b.date)-new Date(a.date));

  // Daily brief
  const hot=items.filter(i=>i.importance==='hot').slice(0,5);
  const notable=items.filter(i=>i.importance==='notable');
  let briefItems=[...hot];
  if(briefItems.length<3)briefItems=[...briefItems,...notable.filter(n=>!briefItems.find(b=>b.id===n.id))].slice(0,5);

  let html=`<div class="section-title">üì° Intel</div>
    <div class="daily-brief">
      <div style="font-weight:700;font-size:1.1rem;margin-bottom:0.25rem">üéØ Daily Brief</div>
      <div style="font-size:0.8rem;color:var(--muted);margin-bottom:1rem">Your daily intelligence briefing</div>
      <div class="card-grid">${briefItems.length?briefItems.map(i=>intelCardSmall(i)).join(''):'<div style="color:var(--muted)">No items yet ‚Äî add intel below</div>'}</div>
    </div>`;

  // Filter bar
  html+=`<div class="filter-bar">
    <select class="form-select" onchange="window._intelCat=this.value;renderContent()" id="intelCatFilter">
      ${['All','CMMC News','Industry Trends','Competitor Watch','Opportunities'].map(c=>`<option ${window._intelCat===c?'selected':''}>${c}</option>`).join('')}</select>
    <select class="form-select" onchange="window._intelImp=this.value;renderContent()" id="intelImpFilter">
      ${['All','hot','notable','reference'].map(c=>`<option ${window._intelImp===c?'selected':''} value="${c}">${c==='All'?'All Importance':c==='hot'?'üî• Hot':c==='notable'?'‚ö° Notable':'üìå Reference'}</option>`).join('')}</select>
    <button class="btn btn-primary" onclick="showIntelForm=!showIntelForm;editIntelId=null;renderContent()">+ Add Intel</button>
  </div>`;

  if(showIntelForm){
    const it=editIntelId?items.find(x=>x.id===editIntelId):null;
    html+=`<div class="inline-form">
      <div class="form-group"><label>Title</label><input class="form-input" id="iTitle" value="${esc(it?.title||'')}"></div>
      <div class="form-group"><label>Summary</label><textarea class="form-textarea" id="iSummary">${esc(it?.summary||'')}</textarea></div>
      <div style="display:flex;gap:1rem;flex-wrap:wrap">
        <div class="form-group" style="flex:2;min-width:180px"><label>Source URL</label><input class="form-input" id="iSource" value="${esc(it?.source||'')}"></div>
        <div class="form-group" style="flex:1;min-width:150px"><label>Category</label><select class="form-select" id="iCat">
          ${['CMMC News','Industry Trends','Competitor Watch','Opportunities'].map(c=>`<option ${it?.category===c?'selected':''}>${c}</option>`).join('')}</select></div>
        <div class="form-group" style="flex:1;min-width:120px"><label>Importance</label><select class="form-select" id="iImp">
          ${['hot','notable','reference'].map(c=>`<option ${it?.importance===c?'selected':''}>${c}</option>`).join('')}</select></div>
      </div>
      <button class="btn btn-primary" onclick="saveIntel()">${it?'Update':'Save'}</button>
      <button class="btn btn-ghost" onclick="showIntelForm=false;editIntelId=null;renderContent()" style="margin-left:0.5rem">Cancel</button>
    </div>`;
  }

  // Filtered feed
  let filtered=items;
  if(window._intelCat!=='All')filtered=filtered.filter(i=>i.category===window._intelCat);
  if(window._intelImp!=='All')filtered=filtered.filter(i=>i.importance===window._intelImp);

  html+='<div style="margin-top:1.5rem">'+filtered.map(i=>intelCardFull(i)).join('')+'</div>';
  if(!filtered.length)html+='<div class="card" style="text-align:center;color:var(--muted);padding:2rem">No intel items match your filters</div>';
  return html;
}

function intelCardSmall(i){
  const catClass=i.category==='CMMC News'?'badge-cmmc':i.category==='Industry Trends'?'badge-trends':i.category==='Competitor Watch'?'badge-competitor':'badge-opportunities';
  return `<div class="card" style="border-color:rgba(59,130,246,0.2)">
    <div style="font-weight:700;font-size:0.95rem">${esc(i.title)}</div>
    <p style="color:var(--muted);font-size:0.8rem;margin-top:0.35rem">${esc(i.summary.slice(0,120))}...</p>
    <div style="margin-top:0.5rem"><span class="badge ${catClass}">${i.category}</span></div>
  </div>`;
}

function intelCardFull(i){
  const catClass=i.category==='CMMC News'?'badge-cmmc':i.category==='Industry Trends'?'badge-trends':i.category==='Competitor Watch'?'badge-competitor':'badge-opportunities';
  const impClass=i.importance==='hot'?'badge-hot':i.importance==='notable'?'badge-notable':'badge-reference';
  const impIcon=i.importance==='hot'?'üî•':i.importance==='notable'?'‚ö°':'üìå';
  return `<div class="card" style="margin-bottom:1rem">
    <div style="display:flex;justify-content:space-between;align-items:start;flex-wrap:wrap;gap:0.5rem">
      <div style="flex:1;min-width:200px">
        <div style="font-weight:700;font-size:1.05rem">${esc(i.title)}</div>
        <p style="color:var(--muted);font-size:0.85rem;margin-top:0.5rem;line-height:1.5">${esc(i.summary)}</p>
        ${i.source?`<a href="${esc(i.source)}" target="_blank" style="font-size:0.8rem;display:inline-block;margin-top:0.5rem">üîó Source</a>`:''}
        <div style="margin-top:0.75rem;display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap">
          <span class="badge ${catClass}">${i.category}</span>
          <span class="badge ${impClass}">${impIcon} ${i.importance}</span>
          <span style="font-size:0.7rem;color:var(--gray)">${fmtDate(i.date)}</span>
        </div>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-ghost btn-sm" onclick="editIntelId='${i.id}';showIntelForm=true;renderContent()">Edit</button>
      <button class="btn btn-danger btn-sm" onclick="deleteIntel('${i.id}')">Delete</button>
    </div>
  </div>`;
}

function saveIntel(){
  const items=LS.get('intel',[]);
  const data={title:gv('iTitle'),summary:gv('iSummary'),source:gv('iSource'),category:gv('iCat'),importance:gv('iImp')};
  if(!data.title)return;
  if(editIntelId){const i=items.findIndex(x=>x.id===editIntelId);if(i>=0)items[i]={...items[i],...data}}
  else items.unshift({id:genId(),...data,date:new Date().toISOString()});
  LS.set('intel',items);showIntelForm=false;editIntelId=null;renderContent();
}
function deleteIntel(id){if(!confirm('Delete intel item?'))return;LS.set('intel',LS.get('intel',[]).filter(i=>i.id!==id));renderContent()}

// ===== UTILS =====
function gv(id){const el=document.getElementById(id);return el?el.value.trim():''}
function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}

// ===== INIT =====
initData();renderTabs();renderContent();
</script>
</body>
</html>
